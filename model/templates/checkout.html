<!DOCTYPE html>
<html lang="utf-8">

<head>
    {% load static%}
    {% load my_tags %}
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>確認畫面</title>
    <link rel="icon" href="{% static 'images/home_imag/favicon.ico' %}" type="image/x-icon" />

    <!-- 將我們需要的google font字體連接 英文 -->
    <link href="https://fonts.googleapis.com/css?family=Coda&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Inter&display=swap" rel="stylesheet">

    <!-- 將我們需要的google font字體連接 中文 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@700&display=swap" rel="stylesheet">

    <!-- 與css連接 -->
    <link rel="stylesheet" href="{% static 'css/checkout.css' %}">

    <!-- 連接bootstrap相關資源 -->
    <!-- Latest compiled and minified CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <!-- Popper JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
        crossorigin="anonymous"></script>

    <script type="text/javascript" src="{% static  'js/jquery-3.6.0.min.js' %}"></script>
    <!-- 使用標籤 -->
    

</head>
<style>
    .btn-primary, .btn-primary:hover, .btn-primary:active, .btn-primary:visited {
    background-color: #000513 !important;
    color: #56E096!important;
    font-family: Coda!important;
}
</style>
<body class="container-head container-fluid" style="height: 100%;">
    <div>
        <div class="row  text-center">
			<div class="col-1 ">
				
			</div>
			<div class="col-2 text-left">
				<a href="{% url 'home' %}"><img  type ="button" id="logo" src="{% static 'images/home_imag/logo.svg' %}" ></a>
			</div>
			<div class="col-2 d-flex text-left align-items-center">
				<p class="checkout_txt"><b>結帳</b></p>
			</div>
			<div class="col">
			</div>
		</div>

        <div style="height: 80px;"></div>

        <div class="container">
            <!-- justify-content-around 平均寬 -->
            <div class="row justify-content-around">
                <div class="col-10">

                    <table class="table">
                        <thead class="table_title">
                            <tr>
                                <!-- 全選checkbox -->
                                <!-- <th scope="col" class="text-center"><input class="form-check-input" type="checkbox"
                                        value="" id="check_all"></th> -->
                                <th scope="col" colspan="2">
                                    <div class="form-check">
                                        <label class="form-check-label  text-right" for="Product">
                                            <b>全部商品</b>
                                        </label>
                                    </div>
                                </th>
                                <th scope="col" class="text-center"><b>單價</b></th>
                                <th scope="col" class="text-center"><b>數量</b></th>
                                <th scope="col" class="text-center"><b>總計</b></th>
                                <!-- <th scope="col"></th> -->
                            </tr>
                        </thead>
                        <tbody class="table_content">
                            {% for i in pd %}
                            <!-- vertical-align:middle; 垂直置中 -->
                            <tr style="vertical-align:middle;">
                                <!-- 商品checkbox -->
                                <!-- <td style="width: 5%;"><input class="form-check-input s_chk" type="checkbox" value="{% widthratio i.counts 1 i.product_name.price %}"
                                        id="{{ i.id }}"></td> -->
                                <!-- 商品圖片 -->
                                <td style="width: 15%;">
                                    <image width="100px" src="{% static i.product_name.product_name|image %}">
                                </td>
                                <!-- 商品名稱 -->
                                <td style="width: 30%; color: white;">{{ i.product_name.product_name }}</td>
                                <!-- 商品單價 -->
                                <td class="text-center" style="width: 15%;">{{ i.product_name.price }}</td>
                                <!-- 商品數量 -->
                                <td class="text-center" style="width: 15%;">
                                    {{ i.counts }}
                                </td>
                                <!-- 商品總計 -->
                                <td class="text-center" style="width: 15%;">
                                    {% widthratio i.counts 1 i.product_name.price %}
                                </td>
                                <!-- 刪除button -->
                                <!-- <td style="width: 5%;"><a href="{% url 'delete_check' i.id %}"><img type="button" class="icon" src="{% static 'images/home_imag/delete_icon.png' %}"></a></td> -->
                            </tr>
                            {% endfor %}
                            
                        </tbody>
                    </table>
                    <br><br><br>

                    <nav>
                        <div class="nav nav-tabs" id="nav-tab" role="tablist">
                            <!-- 頁籤 -->
                            <samp class="title" style="width: 25%;"><b> 付款方式 </b></samp>
                            <!-- 切換到 貨到付款 -->
                            <button class="n-nav-link active" id="cash-tab" data-bs-toggle="tab" data-bs-target="#cash"
                                type="button" role="tab" aria-controls="cash" style="width: 25%;"
                                aria-selected="true"><b id="cod_"> 貨到付款 </b></button>
                            <!-- 切換到 信用卡/簽帳卡 -->
                            <button class="n-nav-link" id="visa-tab" data-bs-toggle="tab" data-bs-target="#visa"
                                type="button" role="tab" aria-controls="visa" style="width: 25%;"
                                aria-selected="false"><b id="cc_"> 信用卡/簽帳卡 </b></button>
                            <!-- 切換到 ATM轉帳 -->
                            <button class="n-nav-link" id="atm-tab" data-bs-toggle="tab" data-bs-target="#atm"
                                type="button" role="tab" aria-controls="atm" style="width: 25%;"
                                aria-selected="false"><b id="atm_"> ATM轉帳 </b></button>
                        </div>
                    </nav>

                    <div class="tab-content" id="nav-tabContent">
                        <!-- 貨到付款 頁面-->
                        <div class="tab-pane fade show active" id="cash" role="tabpanel" aria-labelledby="nav-home-tab">
                            <div class="row  justify-content-around">
                                <div class="col-lg-10 col-sm-12 col-xs-12 col-12">
                                    <br><br><br><br>
                                    <table class="fill_in_table">
                                        <tr>
                                            <td style="width: 20%;" class="input_title_txt text-center"><b>
                                                    <spam class="impor">*</spam>取貨人姓名
                                                </b></td>
                                            <td style="width: 30%;">
                                                <input id="cod_name" class="form-control" type="text" placeholder="預設會員姓名"
                                                    aria-label="default input example" value="{{ name }}">
                                            </td>

                                            <td style="width: 20%;" class="input_title_txt text-center"><b>
                                                    <spam class="impor">*</spam>取貨人手機
                                                </b></td>

                                            <td style="width: 30%;">
                                                <input id="cod_phone" class="form-control" type="text" placeholder="預設會員手機"
                                                    aria-label="default input example" value="{{ phone }}">
                                            </td>
                                        </tr>
                                        <!-- 間隔 -->
                                        <tr>
                                            <td colspan="4">　</td>
                                        </tr>
                                        <tr>
                                            <td style="width: 15%;" class="input_title_txt text-center"><b>
                                                    <spam class="impor">*</spam>收件地址　
                                                </b></td>
                                            <td colspan="3" style="width: 85%;"> <input id="cod_address" class="form-control" class="address" type="text"
                                                    aria-label="default input example" >
                                        </tr>
                                    </table>
                                    <br><br>
                                    <table class="fill_in_table">
                                        <tr>
                                            <td style="width: 90%;"></td>

                                            <td style="width: 10%;">
                                                <button id="cod" class="send text-center" ><b>送出</b></button>
                                            </td>
                                    </table>
                                </div>

                            </div>
                        </div>

                        <!-- 信用卡/簽帳卡 頁面-->
                        <div class="tab-pane fade" id="visa" role="tabpanel" aria-labelledby="nav-profile-tab">
                            <b class="impor">※取貨時請出示「有效證件」</b><br>
                            <div class="row  justify-content-around">
                                <div class="col-lg-10 col-sm-12 col-xs-12 col-12">
                                    <br><br><br>

                                    <table class="fill_in_table">
                                        <tr>
                                            <td style="width: 20%;" class="input_title_txt text-center"><b>
                                                    <spam class="impor">*</spam>取貨人姓名
                                                </b></td>

                                            <td style="width: 30%;">
                                                <input id="cc_name" class="form-control" type="text" placeholder="預設會員姓名"
                                                    aria-label="default input example" value="{{ name }}">
                                            </td>

                                            <td style="width: 20%;" class="input_title_txt text-center"><b>
                                                    <spam class="impor">*</spam>取貨人手機
                                                </b></td>

                                            <td style="width: 30%;">
                                                <input id="cc_phone" class="form-control" type="text" placeholder="預設會員手機"
                                                    aria-label="default input example" value="{{ phone }}">
                                            </td>
                                        </tr>
                                        <!-- 間隔 -->
                                        <tr>
                                            <td colspan="4">　</td>
                                        </tr>

                                        <tr>
                                            <td style="width: 15%;" class="input_title_txt text-center"><b>
                                                    <spam class="impor">*</spam>收件地址　
                                                </b></td>
                                            <td colspan="3" style="width: 85%;"> <input id="cc_address" class="form-control" class="address" type="text"
                                                    aria-label="default input example" >
                                        </tr>
                                    </table>

                                    <br><br>

                                    <table class="fill_in_table">
                                        <tr>
                                            <td style="width: 20%;" class="input_title_txt text-center"><b>
                                                    <spam class="impor">*</spam>卡號　　　
                                                </b></td>

                                            <td style="width: 10%;">
                                                <input class="form-control" type="text" maxlength="4">
                                            </td>
                                            <td style="width: 2%;" class="input_title_txt text-center"><b>
                                                    -
                                                </b></td>
                                            <td style="width: 10%;">
                                                <input class="form-control" type="text" maxlength="4">
                                            </td>
                                            <td style="width: 2%;" class="input_title_txt text-center"><b>
                                                    -
                                                </b></td>
                                            <td style="width: 10%;">
                                                <input class="form-control" type="text" maxlength="4">
                                            </td>
                                            <td style="width: 2%;" class="input_title_txt text-center"><b>
                                                    -
                                                </b></td>
                                            <td style="width: 10%;">
                                                <input class="form-control" type="text" maxlength="4">
                                            </td>
                                            <td style="width: 4%;">
                                                　
                                            </td>

                                            <td style="width: 15%;" class="input_title_txt text-center"><b>
                                                    <spam class="impor">*</spam>到期日　　
                                                </b></td>
                                            <td style="width: 15%;">
                                                <input class="form-control" type="text" maxlength="4"
                                                    placeholder="mm/yy">
                                            </td>
                                            <td>
                                        </tr>
                                        <tr>
                                            <td>　
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="width: 15%;" class="input_title_txt text-center">
                                                <b>
                                                    <spam class="impor">*</spam>安全碼　　
                                                </b>
                                            </td>
                                            <td style="width: 15%;">
                                                <input class="form-control" type="text" maxlength="3">
                                            </td>
                                        </tr>

                                    </table>

                                    <table class="fill_in_table">
                                        <tr>
                                            <td style="width: 90%;"></td>

                                            <td style="width: 10%;">
                                                <button id="cc" class="send text-center"><b>送出</b></button>
                                            </td>
                                    </table>

                                </div>
                            </div>
                        </div>


                        <!-- ATM轉帳 頁面-->
                        <div class="tab-pane fade" id="atm" role="tabpanel" aria-labelledby="nav-home-tab">
                            <b class="impor">※取得「轉帳資訊」後請在72小時內完成付款<br>※取貨時請出示「有效證件」</b><br>
                            <div class="row  justify-content-around">
                                <div class="col-lg-10 col-sm-12 col-xs-12 col-12">
                                    <br><br>
                                    <table class="fill_in_table">
                                        <tr>
                                            <td style="width: 20%;" class="input_title_txt text-center"><b>
                                                    <spam class="impor">*</spam>取貨人姓名
                                                </b></td>
                                            <td style="width: 30%;">
                                                <input id="atm_name" class="form-control" type="text" placeholder="預設會員姓名"
                                                    aria-label="default input example" value="{{ name }}">
                                            </td>

                                            <td style="width: 20%;" class="input_title_txt text-center"><b>
                                                    <spam class="impor">*</spam>取貨人手機
                                                </b></td>

                                            <td style="width: 30%;">
                                                <input id="atm_phone" class="form-control" type="text" placeholder="預設會員手機"
                                                    aria-label="default input example" value="{{ phone }}">
                                            </td>
                                        </tr>
                                        <!-- 間隔 -->
                                        <tr>
                                            <td colspan="4">　</td>
                                        </tr>
                                        <tr>
                                            <td style="width: 15%;" class="input_title_txt text-center"><b>
                                                    <spam class="impor">*</spam>收件地址　
                                                </b></td>
                                            <td colspan="3" style="width: 85%;"> <input id="atm_address" class="form-control" type="text"
                                                    aria-label="default input example" >
                                        </tr>
                                    </table>
                                    <br><br>
                                    <table class="fill_in_table">
                                        <tr>
                                            <td style="width: 90%;"></td>

                                            <td style="width: 10%;">
                                                <button id="atm" class="send text-center"><b>送出</b></button>
                                            </td>
                                    </table>

                                    <br>
                                </div>

                            </div>
                        </div>
                    </div>
                    
                    <br><br><br><br>
                    <!-- 釘選底部 -->
                    <div class="row row-cols-2 justify-content-around">
                        <div class="col-4" id="total">
                            <div id="liveAlertPlaceholder" class=""></div>
                            <table>
                                <tr style="vertical-align:middle;">
                                    <td style="width: 5%;"></td>
                                    <td class="text-end item" style="width: 27.5%;" ><b>商品種類　</b></td>
                                    <!-- 商品數量 -->
                                    <td class="text-start item" style="width: 15%;" id="count">{{ counts }}</td>
                                    <td style="width: 5%;"></td>
                                    <td class="text-end total" style="width: 27.5%;"><b>總計　</b></td>
                                    <!-- 總計 -->
                                    <td class="text-start total" style="width: 15%;" id="total_p">{{ total }}</td>
                                    <td style="width: 5%;"></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade  bd-example-modal-lg" id="exampleModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered  modal-lg" >
            <div class="modal-content" style="background-color: rgba(0, 5.000000176951289, 20.000000707805157, 1);">
                <div class="modal-body">

                    <div class="row align-items-center">
                        <!--E-mail-->                                      
                            <label class="Revise_txt text-center">請選擇要結帳的商品<label/>                     
                    </div>

                    <div style="height: 20px;"></div>
                    <div class="row" id="bt">
                        
                        <input type="submit" class="finish text-center" id="model_button" value="確認" >
                        
                        <!-- <button type="button" class="finish text-center" data-bs-dismiss="modal">Finish</button> -->
                    </div>

                </div>
            </div>
        </div>
    </div>
</body>
<script>
    if (document.addEventListener) {
        window.addEventListener('pageshow', function (event) {
            if (event.persisted || performance.getEntriesByType("navigation")[0].type === 'back_forward') {
                location.reload();
            }
        },
        false);
    }
</script>
<script>
    var true_count=0
    $("#check_all").on("click", function() {
        var obj = document.getElementsByClassName("s_chk")
        var count=0
        var c=document.getElementById('count')
        var t=document.getElementById('total_p')
        let price=0
        if(this.checked==true)
        {           
            count=obj.length
            for(var k in obj){
            obj[k].checked=true
            if(obj[k].value!=undefined)
            price+=parseInt(obj[k].value)       
            }             
        }else{
            for(var k in obj){
            obj[k].checked=false     
            }
        }
        c.innerText=count
        t.innerText=price
  });
  $('#model_button').on('click',function(){
    $("#exampleModal").modal("hide");
  });
  $(".s_chk").on("click", function() {
    let c_a=document.getElementById('check_all')
    var t=document.getElementById('total_p')
    let price=parseInt(t.innerText)
    let c=document.getElementById('count')
    let count=parseInt(c.innerText)
    let s=document.getElementsByClassName('s_chk') 
    c_a.checked=false
    if(this.checked==true){
        price+=parseInt(this.value)
        count+=1
    }else{
        price-=parseInt(this.value)
        count-=1
    }
    if(count==s.length){
        c_a.checked=true
    }
    c.innerText=count
    t.innerText=price
  });

  $(".send").on("click", function() {
    var obj = document.getElementsByClassName("s_chk");
    var check_val = [];
    let c=document.getElementById('count')
    const exampleModal = document.getElementById('exampleModal')
    const modellabel=exampleModal.querySelector('.modal-body label')
    if($(`#${this.id}_address`).val()=='' || $(`#${this.id}_name`).val()=='' || $(`#${this.id}_phone`).val()==''){
        // const bt=document.getElementById('bt')
        // bt.innerHTML=`<input type="submit" class="finish text-center" id="model_button" value="確認" >`
        modellabel.textContent='還有資料尚未填入'
        $("#exampleModal").modal("show");
        event.preventDefault()
    }else{
        for(var k in obj){
        if(obj[k].checked)
            check_val.push(obj[k].id);
        }
        $.ajax({
            url: "{% url 'save_order' %}",
            data: {
            chk_id:check_val,
            address:$(`#${this.id}_address`).val(),
            name:$(`#${this.id}_name`).val(),
            phone:$(`#${this.id}_phone`).val(),
            cate:$.trim($(`#${this.id}_`).text()),
            total:$(`#total_p`).text()
            },                           
            type:"POST",
            dataType:'json',
            success: function(message){
                event.preventDefault() 
                const bt=document.getElementById('bt')
                modellabel.textContent='訂單已送出'
                console.log(bt.innerHTML)
                bt.innerHTML=`<a href="{% url 'home' %}"><input type="button" class="finish text-center" id="model_button" value="確認" ></a>`
                $("#exampleModal").modal("show");
                             
            },

            error:   function(jqXHR, textStatus, errorThrown){ 

            }
        });
    }
  });
</script>
</html>