
<html>

<head>
  {% load static%}
  {% load my_tags %}
  <meta charset="utf-8">
  <link href="https://fonts.googleapis.com/css?family=Coda&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Inter&display=swap" rel="stylesheet">
  <!-- <link rel="stylesheet" href="/static/css/styles.css"> -->

  <link rel="stylesheet" href="{% static 'css/login.css' %}">
  <link rel="stylesheet" href="{% static 'css/sign_up.css' %}">
  <link rel="stylesheet" href="{% static 'css/shopping_cart.css' %}">
  <link rel="stylesheet" href="{% static 'css/home.css' %}">

  <link rel="stylesheet" href="/static/plugins/bootstrap-5.2.1-dist/css/bootstrap.min.css" />
  <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"> -->
  <!-- <script type="text/javascript" src="{% static  'plugins/bootstrap-5.2.0-beta1-dist/js/bootstrap.bundle.min.js' %}">
  </script> -->
  <script type="text/javascript" src="{% static  'js/jquery-3.6.0.min.js' %}"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8" />
  <!-- <script type="text/javascript" src="{% static  'plugins/bootstrap-5.2.0-beta1-dist/js/bootstrap.min.js' %}">
  </script> -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
  crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <title>購物車</title>
</head>
<style>
  .control1 {
    color: #56E096;
    background-color: #000513;
    font-family: Coda;
}
.btn-primary, .btn-primary:hover, .btn-primary:active, .btn-primary:visited {
    background-color: #000513 !important;
    color: #56E096!important;
    font-family: Coda!important;
}
.self-search{
        background-image: url("{% static 'images/home_imag/search_background.png' %}");
    }
</style>
<body class="container-head">
  <div class="container-head text-center container-fluid">
    <!-- text-center 水平置中 -->
    <div class="row">
      <div class="col-sm-2">
        <!-- col-sm-X 依照畫面縮放排版 -->
        <a href="{% url 'home' %}"><img type="button" id="logo" src="{% static 'images/home_imag/logo.png' %}"></a>
        <!--logo-->
      </div>
      <div class="col-sm-8">
      </div>
      <div class="col-sm-2 d-flex align-items-center">
        <!-- align-items-center 垂直置中 -->
  
        <div>
          <a href="{% url 'shopping_cart' %}"><img type="button" id="shopping_icon" class="icon position-relative"
              src="{% static 'images/home_imag/shopping_cart_icon.png' %}"></a>
          <!--購物車button-->
          {% if request.user.is_authenticated %}
          <span class="position-absolute  translate-middle shoppring_much_bg rounded-pill text-light" id="shopping_cart_count">
            {{ shopping_cart_count }}
            <span class="visually-hidden">unread messages</span>
          </span>
          {% endif %}
        </div>
  
        <p style="padding:20px;"></p>
        {% if request.user.is_authenticated %}
        <div class="dropdown">
          <img type="button" class="icon" src="{% static 'images/home_imag/member_icon.png' %}" id="member_centre"
            data-bs-toggle="dropdown" aria-expanded="false">
          <!--會員與登入button-->
          <ul class="dropdown-menu dropdown-menu-end" style="background-color:#1c2f4d; border-radius: 0.5rem;"
            aria-labelledby="member_centre">
  
            <!--購買紀錄-->
            <li><span type="button" class="purchase_record "
                onclick="javascript:location.href='../purchase_record'">購買紀錄</span></li>
  
            <!--會員資料-->
            <li><a href="{% url 'member_profile' %}" class="text-decoration-none"><span type="button" class="member_profile">會員資料</span></a>
            </li>
  
            <!--我的最愛-->
            <!-- <li><span type ="button"class="saved" onclick="javascript:location.href='../saved'">Saved</span></li> -->
            <li><a href="{% url 'tracking_list' %}" class="text-decoration-none"><span type ="button"class="saved">追蹤清單</span></a></li>

            <!--更改密碼-->
            <li><a href="{% url 'password_reset' %}" class="text-decoration-none"><span type="button" class="change_password">更改密碼</span></a></li>
  
            <li>
              <hr class="dropdown-divider">
            </li>
  
            <!--登出-->
            <li><span type="button" class="sign_out"><a href="{% url 'logout' %}" class="text-decoration-none">登出</a></span></li>
  
          </ul>
        </div>
        {% else %}
        <a href="{% url 'login1' %}"><img type="button" class="icon" src="{% static 'images/home_imag/member_icon.png' %}"
            id="member_centre"></a>
        {% endif %}
      </div>
    </div>
  <br><br>
  <br>
  <form method="post" id="form">
  <div class="container">
    <div class="row row-cols-2 text-center">
      {% csrf_token %}
      {% for product in products %}
      <div class="col col-mb-3">
        <div class="row">
          <div class="col-0 col-lg-6 col-sm-0">
            <image width="100%" class="img_hdn" src="{% static  product.product_name.product_name|image %}">
          </div>
          <div class="col col-lg-6 col-sm-12">
            <div class="COMM_name">
              {{ product.product_name.product_name }} 
            </div>
            <br>
            <div>
              <!-- url 'product' product.product_name.id  -->
              <!-- <a href="#" class="">詳細資料</a> -->
            </div>
            <br><br>
            <div class="row">
              <div class="COMM_price col-8">
                $ {{ product.product_name.price }}
              </div>
              <div class="col-4">
                <!-- url 'delete_product' product.id -->
                <a href="{% url 'delete_product' product.id %}" class="text-decoration-none">刪除</a>
              </div>
            </div>
            <div class="input-group w-auto p-3 " class="a">
              <input id="{{ product.product_name.id }}" type="button" class="form-control counts  btn btn-primary btn-outline-light" value="-">
              <input id="text_{{ product.product_name.id }}" type="text" class="form-control text-center text  btn btn-primary btn-outline-light" value="{{ product.counts }}" onfocus="this.select()">
              <input id="{{ product.product_name.id }}" type="button" class="form-control counts  btn btn-primary btn-outline-light" value="+">
            </div>
          </div>
        </div>
      </div>
      <br><br>
      {% endfor %}
      {% if count != 0 %}
      <div id="BUY" type="button"  style="width:80px ;height:60px;">
        <div id="liveAlertPlaceholder" class=""></div>
        <form method="post">
            <!-- url 'buy' -->
            <a href="{% url 'check_out' %}"><img style="width:40px ;height:40px;" src="{% static 'images/home_imag/buy.svg' %}"></a>
        </form>
      </div>
      {% else %}
      <div class="text-light">
        購物車是空的
      </div>
      {% endif %}

    </div>
    <div aria-live="polite" aria-atomic="true" class="d-flex justify-content-center align-items-center"
      style="min-height: 200px;">

      <div id="liveToast" class="toast bg-success" role="alert" aria-live="assertive" aria-atomic="true"
        data-bs-delay="2000">
        <div class="toast-body " id="toast-body">
          商品已更新
        </div>
      </div>

    </div>
  </div>
</form>
</body>
<script type="text/javascript"
src="{% static  'js/jquery-3.6.0.min.js' %}"></script>
<script>
  const alertPlaceholder = document.getElementById('liveAlertPlaceholder')
  const alert = (message, type) => {
  const wrapper = document.createElement('div')
  wrapper.innerHTML = [
    `<div class="alert alert-${type} alert-dismissible" role="alert">`,
    `   <div>${message}</div>`,
    '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
    '</div>'
  ].join('')
  alertPlaceholder.append(wrapper)
  }
  $(".select_op").on("change", function() {
    $.ajax({
        url: "{% url 'shopping_cart' %}",
        data: {
          id:this.id,
          select_value:this.value,
          csrfmiddlewaretoken: '{{ csrf_token }}'
        },                           
        type:"POST",
        dataType:'json',

        success: function(message){
          const toastLiveExample = document.getElementById('liveToast')
          const toast = new bootstrap.Toast(toastLiveExample)         
              
          alert('更改成功', 'success')    
          toast.show()
        },

        error:   function(jqXHR, textStatus, errorThrown){ 
            document.getElementById("message").innerHTML=errorThrown; 
        }
    });
  });
  $(".counts").on("click", function() {
    $.ajax({
        url: "{% url 'shopping_cart' %}",
        data: {
          id:this.id,
          input_value:this.value,
          data:$('#text_'+this.id).val()
        },                           
        type:"POST",
        dataType:'json',
        success: function(message){
          const input_text=document.getElementById(message['id'])
          const toastLiveExample = document.getElementById('liveToast')
          const toast = new bootstrap.Toast(toastLiveExample)
          const toastBody = document.getElementById("toast-body")
          toastBody.innerText="商品已更新"
          toastLiveExample.className="toast bg-success"         
            
          input_text.value=message['test'] 
          // alert('更改成功', 'success')    
          toast.show()
        },

        error:   function(jqXHR, textStatus, errorThrown){ 
          const toastLiveExample = document.getElementById('liveToast')
          const toast = new bootstrap.Toast(toastLiveExample)
          const toastBody = document.getElementById("toast-body")
          toastLiveExample.className="toast bg-danger"
          toastBody.innerText="輸入值只能是數字"
          toast.show()
        }
    });
  });
  $(".text").on("change", function() {
    console.log('a')
    $.ajax({
        url: "{% url 'shopping_cart' %}",
        data: {
          id:this.id.slice(5),
          input_value:'text',
          data:this.value
        },                           
        type:"POST",
        dataType:'json',

        success: function(message){
          const input_text=document.getElementById(message['id'])
          const toastLiveExample = document.getElementById('liveToast')
          const toast = new bootstrap.Toast(toastLiveExample)
          const toastBody = document.getElementById("toast-body")
          toastBody.innerText="商品已更新"
          toastLiveExample.className="toast bg-success"     
          input_text.value=message['test']         
                 
          toast.show()
        },

        error:   function(jqXHR, textStatus, errorThrown){ 
          const toastLiveExample = document.getElementById('liveToast')
          const toast = new bootstrap.Toast(toastLiveExample)
          const toastBody = document.getElementById("toast-body")
          toastBody.innerText="輸入值只能是數字"
          toastLiveExample.className="toast bg-danger"
          toast.show()
        }
    });
  });
  $(document).on("keypress", "form", function (e) {
    var code = e.keyCode || e.which;
    if (code == 13) {
        e.preventDefault();
        return false;
    }
});
</script>
</html>